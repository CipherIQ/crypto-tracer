// SPDX-License-Identifier: GPL-3.0-or-later
/**
 * Copyright (c) 2025 Graziano Labs Corp.
 */

/**
 * test_argument_parser.c - Unit tests for command-line argument parsing
 * Tests all commands, options, and validation logic
 * Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 11.1, 11.2, 11.3, 11.4, 11.5
 */

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <assert.h>
#include "../../src/include/crypto_tracer.h"

/* Test counter */
static int tests_passed = 0;
static int tests_failed = 0;

#define TEST(name) \
    do { \
        printf("Running test: %s\n", name); \
    } while (0)

#define ASSERT_EQ(actual, expected, message) \
    do { \
        if ((actual) != (expected)) { \
            printf("  FAILED: %s (expected %d, got %d)\n", message, expected, actual); \
            tests_failed++; \
            return; \
        } \
    } while (0)

#define ASSERT_STR_EQ(actual, expected, message) \
    do { \
        if (strcmp(actual, expected) != 0) { \
            printf("  FAILED: %s (expected '%s', got '%s')\n", message, expected, actual); \
            tests_failed++; \
            return; \
        } \
    } while (0)

#define ASSERT_TRUE(condition, message) \
    do { \
        if (!(condition)) { \
            printf("  FAILED: %s\n", message); \
            tests_failed++; \
            return; \
        } \
    } while (0)

#define TEST_PASS() \
    do { \
        printf("  PASSED\n"); \
        tests_passed++; \
    } while (0)

/**
 * Test: Monitor command with no options
 */
void test_monitor_command_basic(void) {
    TEST("monitor_command_basic");
    
    char *argv[] = {"crypto-tracer", "monitor"};
    int argc = 2;
    
    cli_args_t args = {0};
    int result = parse_args(argc, argv, &args);
    
    ASSERT_EQ(result, 0, "parse_args should succeed");
    ASSERT_EQ(args.command, CMD_MONITOR, "command should be CMD_MONITOR");
    ASSERT_EQ(args.duration, 0, "duration should be 0 (unlimited)");
    ASSERT_TRUE(args.output_file == NULL, "output_file should be NULL");
    ASSERT_EQ(args.format, FORMAT_JSON_STREAM, "format should be FORMAT_JSON_STREAM");
    
    TEST_PASS();
}

/**
 * Test: Monitor command with duration
 */
void test_monitor_command_with_duration(void) {
    TEST("monitor_command_with_duration");
    
    char *argv[] = {"crypto-tracer", "monitor", "--duration", "60"};
    int argc = 4;
    
    cli_args_t args = {0};
    int result = parse_args(argc, argv, &args);
    
    ASSERT_EQ(result, 0, "parse_args should succeed");
    ASSERT_EQ(args.command, CMD_MONITOR, "command should be CMD_MONITOR");
    ASSERT_EQ(args.duration, 60, "duration should be 60");
    
    TEST_PASS();
}

/**
 * Test: Monitor command with output file
 */
void test_monitor_command_with_output(void) {
    TEST("monitor_command_with_output");
    
    char *argv[] = {"crypto-tracer", "monitor", "--output", "/tmp/output.json"};
    int argc = 4;
    
    cli_args_t args = {0};
    int result = parse_args(argc, argv, &args);
    
    ASSERT_EQ(result, 0, "parse_args should succeed");
    ASSERT_EQ(args.command, CMD_MONITOR, "command should be CMD_MONITOR");
    ASSERT_STR_EQ(args.output_file, "/tmp/output.json", "output_file should match");
    
    TEST_PASS();
}

/**
 * Test: Monitor command with PID filter
 */
void test_monitor_command_with_pid(void) {
    TEST("monitor_command_with_pid");
    
    char *argv[] = {"crypto-tracer", "monitor", "--pid", "1234"};
    int argc = 4;
    
    cli_args_t args = {0};
    int result = parse_args(argc, argv, &args);
    
    ASSERT_EQ(result, 0, "parse_args should succeed");
    ASSERT_EQ(args.command, CMD_MONITOR, "command should be CMD_MONITOR");
    ASSERT_EQ(args.pid, 1234, "pid should be 1234");
    
    TEST_PASS();
}

/**
 * Test: Monitor command with process name filter
 */
void test_monitor_command_with_process_name(void) {
    TEST("monitor_command_with_process_name");
    
    char *argv[] = {"crypto-tracer", "monitor", "--name", "nginx"};
    int argc = 4;
    
    cli_args_t args = {0};
    int result = parse_args(argc, argv, &args);
    
    ASSERT_EQ(result, 0, "parse_args should succeed");
    ASSERT_EQ(args.command, CMD_MONITOR, "command should be CMD_MONITOR");
    ASSERT_STR_EQ(args.process_name, "nginx", "process_name should be nginx");
    
    TEST_PASS();
}

/**
 * Test: Monitor command with library filter
 */
void test_monitor_command_with_library(void) {
    TEST("monitor_command_with_library");
    
    char *argv[] = {"crypto-tracer", "monitor", "--library", "libssl"};
    int argc = 4;
    
    cli_args_t args = {0};
    int result = parse_args(argc, argv, &args);
    
    ASSERT_EQ(result, 0, "parse_args should succeed");
    ASSERT_EQ(args.command, CMD_MONITOR, "command should be CMD_MONITOR");
    ASSERT_STR_EQ(args.library_filter, "libssl", "library_filter should be libssl");
    
    TEST_PASS();
}

/**
 * Test: Monitor command with file filter
 */
void test_monitor_command_with_file(void) {
    TEST("monitor_command_with_file");
    
    char *argv[] = {"crypto-tracer", "monitor", "--file", "/etc/ssl/*.pem"};
    int argc = 4;
    
    cli_args_t args = {0};
    int result = parse_args(argc, argv, &args);
    
    ASSERT_EQ(result, 0, "parse_args should succeed");
    ASSERT_EQ(args.command, CMD_MONITOR, "command should be CMD_MONITOR");
    ASSERT_STR_EQ(args.file_filter, "/etc/ssl/*.pem", "file_filter should match");
    
    TEST_PASS();
}

/**
 * Test: Profile command with PID
 */
void test_profile_command_with_pid(void) {
    TEST("profile_command_with_pid");
    
    char *argv[] = {"crypto-tracer", "profile", "--pid", "1234"};
    int argc = 4;
    
    cli_args_t args = {0};
    int result = parse_args(argc, argv, &args);
    
    ASSERT_EQ(result, 0, "parse_args should succeed");
    ASSERT_EQ(args.command, CMD_PROFILE, "command should be CMD_PROFILE");
    ASSERT_EQ(args.pid, 1234, "pid should be 1234");
    
    TEST_PASS();
}

/**
 * Test: Profile command with process name
 */
void test_profile_command_with_name(void) {
    TEST("profile_command_with_name");
    
    char *argv[] = {"crypto-tracer", "profile", "--name", "nginx"};
    int argc = 4;
    
    cli_args_t args = {0};
    int result = parse_args(argc, argv, &args);
    
    ASSERT_EQ(result, 0, "parse_args should succeed");
    ASSERT_EQ(args.command, CMD_PROFILE, "command should be CMD_PROFILE");
    ASSERT_STR_EQ(args.process_name, "nginx", "process_name should be nginx");
    
    TEST_PASS();
}

/**
 * Test: Profile command with duration
 */
void test_profile_command_with_duration(void) {
    TEST("profile_command_with_duration");
    
    char *argv[] = {"crypto-tracer", "profile", "--pid", "1234", "--duration", "30"};
    int argc = 6;
    
    cli_args_t args = {0};
    int result = parse_args(argc, argv, &args);
    
    ASSERT_EQ(result, 0, "parse_args should succeed");
    ASSERT_EQ(args.command, CMD_PROFILE, "command should be CMD_PROFILE");
    ASSERT_EQ(args.duration, 30, "duration should be 30");
    
    TEST_PASS();
}

/**
 * Test: Snapshot command
 */
void test_snapshot_command(void) {
    TEST("snapshot_command");
    
    char *argv[] = {"crypto-tracer", "snapshot"};
    int argc = 2;
    
    cli_args_t args = {0};
    int result = parse_args(argc, argv, &args);
    
    ASSERT_EQ(result, 0, "parse_args should succeed");
    ASSERT_EQ(args.command, CMD_SNAPSHOT, "command should be CMD_SNAPSHOT");
    
    TEST_PASS();
}

/**
 * Test: Libs command
 */
void test_libs_command(void) {
    TEST("libs_command");
    
    char *argv[] = {"crypto-tracer", "libs"};
    int argc = 2;
    
    cli_args_t args = {0};
    int result = parse_args(argc, argv, &args);
    
    ASSERT_EQ(result, 0, "parse_args should succeed");
    ASSERT_EQ(args.command, CMD_LIBS, "command should be CMD_LIBS");
    
    TEST_PASS();
}

/**
 * Test: Files command
 */
void test_files_command(void) {
    TEST("files_command");
    
    char *argv[] = {"crypto-tracer", "files"};
    int argc = 2;
    
    cli_args_t args = {0};
    int result = parse_args(argc, argv, &args);
    
    ASSERT_EQ(result, 0, "parse_args should succeed");
    ASSERT_EQ(args.command, CMD_FILES, "command should be CMD_FILES");
    
    TEST_PASS();
}

/**
 * Test: Invalid command
 */
void test_invalid_command(void) {
    TEST("invalid_command");
    
    char *argv[] = {"crypto-tracer", "invalid"};
    int argc = 2;
    
    cli_args_t args = {0};
    int result = parse_args(argc, argv, &args);
    
    ASSERT_TRUE(result != 0, "parse_args should fail for invalid command");
    
    TEST_PASS();
}

/**
 * Test: No command provided
 */
void test_no_command(void) {
    TEST("no_command");
    
    char *argv[] = {"crypto-tracer"};
    int argc = 1;
    
    cli_args_t args = {0};
    int result = parse_args(argc, argv, &args);
    
    ASSERT_TRUE(result != 0, "parse_args should fail when no command provided");
    
    TEST_PASS();
}

/**
 * Test: --verbose flag
 */
void test_verbose_flag(void) {
    TEST("verbose_flag");
    
    char *argv[] = {"crypto-tracer", "monitor", "--verbose"};
    int argc = 3;
    
    cli_args_t args = {0};
    int result = parse_args(argc, argv, &args);
    
    ASSERT_EQ(result, 0, "parse_args should succeed");
    ASSERT_TRUE(args.verbose, "verbose should be true");
    
    TEST_PASS();
}

/**
 * Test: --quiet flag
 */
void test_quiet_flag(void) {
    TEST("quiet_flag");
    
    char *argv[] = {"crypto-tracer", "monitor", "--quiet"};
    int argc = 3;
    
    cli_args_t args = {0};
    int result = parse_args(argc, argv, &args);
    
    ASSERT_EQ(result, 0, "parse_args should succeed");
    ASSERT_TRUE(args.quiet, "quiet should be true");
    
    TEST_PASS();
}

/**
 * Test: --no-redact flag
 */
void test_no_redact_flag(void) {
    TEST("no_redact_flag");
    
    char *argv[] = {"crypto-tracer", "monitor", "--no-redact"};
    int argc = 3;
    
    cli_args_t args = {0};
    int result = parse_args(argc, argv, &args);
    
    ASSERT_EQ(result, 0, "parse_args should succeed");
    ASSERT_TRUE(args.no_redact, "no_redact should be true");
    
    TEST_PASS();
}

/**
 * Test: Invalid duration (negative)
 */
void test_invalid_duration_negative(void) {
    TEST("invalid_duration_negative");
    
    char *argv[] = {"crypto-tracer", "monitor", "--duration", "-10"};
    int argc = 4;
    
    cli_args_t args = {0};
    int result = parse_args(argc, argv, &args);
    
    ASSERT_TRUE(result != 0, "parse_args should fail for negative duration");
    
    TEST_PASS();
}

/**
 * Test: Invalid PID (negative)
 */
void test_invalid_pid_negative(void) {
    TEST("invalid_pid_negative");
    
    char *argv[] = {"crypto-tracer", "profile", "--pid", "-1"};
    int argc = 4;
    
    cli_args_t args = {0};
    int result = parse_args(argc, argv, &args);
    
    ASSERT_TRUE(result != 0, "parse_args should fail for negative PID");
    
    TEST_PASS();
}

/**
 * Test: Profile command without PID or name
 */
void test_profile_without_target(void) {
    TEST("profile_without_target");
    
    char *argv[] = {"crypto-tracer", "profile"};
    int argc = 2;
    
    cli_args_t args = {0};
    int result = parse_args(argc, argv, &args);
    
    ASSERT_TRUE(result != 0, "parse_args should fail when profile has no target");
    
    TEST_PASS();
}

/**
 * Main test runner
 */
int main(void) {
    printf("=== Argument Parser Unit Tests ===\n\n");
    
    /* Valid command tests */
    test_monitor_command_basic();
    test_monitor_command_with_duration();
    test_monitor_command_with_output();
    test_monitor_command_with_pid();
    test_monitor_command_with_process_name();
    test_monitor_command_with_library();
    test_monitor_command_with_file();
    test_profile_command_with_pid();
    test_profile_command_with_name();
    test_profile_command_with_duration();
    test_snapshot_command();
    test_libs_command();
    test_files_command();
    
    /* Flag tests */
    test_verbose_flag();
    test_quiet_flag();
    test_no_redact_flag();
    
    /* Invalid input tests */
    test_invalid_command();
    test_no_command();
    test_invalid_duration_negative();
    test_invalid_pid_negative();
    test_profile_without_target();
    
    /* Print summary */
    printf("\n=== Test Summary ===\n");
    printf("Tests passed: %d\n", tests_passed);
    printf("Tests failed: %d\n", tests_failed);
    
    if (tests_failed > 0) {
        printf("\nSome tests FAILED!\n");
        return 1;
    }
    
    printf("\nAll tests PASSED!\n");
    return 0;
}
